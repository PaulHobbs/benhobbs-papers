<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Flexibility Options for Power Grids</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
          }
        };
      </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>
    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <!-- D3.js (Optional, if needed for complex charts) -->
    <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->

    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            padding-top: 20px; /* Add padding for fixed navbar if used */
        }
        .interactive-visualization {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 200px; /* Ensure space for drawing */
            position: relative; /* Needed for absolute positioning of tooltips/labels if any */
        }
        .explanation {
            margin-bottom: 30px;
        }
        h2, h3 {
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        code {
            background-color: #eee;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .slider-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .value-display {
            font-weight: bold;
            color: #0d6efd; /* Bootstrap primary color */
        }
        .param-control {
            margin-bottom: 15px;
        }
        #foDualTriggerViz canvas {
             /* Prevent canvas overflow */
            max-width: 100%;
            height: auto;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 5px solid #0d6efd;
            padding: 15px;
            margin: 15px 0;
        }
        .term {
            font-weight: bold;
            color: #198754; /* Bootstrap success color */
        }
        .equation {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow-x: auto;
        }
         /* Style for p5.js text labels */
        .p5-label {
            position: absolute;
            font-size: 12px;
            color: #333;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 4px;
            border-radius: 2px;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .axis-label {
            font-size: 0.8em;
            fill: #555;
        }
        .grid-line {
            stroke: #eee;
            stroke-dasharray: 2,2;
        }
        .trigger-line {
            stroke-width: 1.5px;
            stroke-dasharray: 4,4;
        }
        .actual-line {
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-5">
            <h1>Flexibility Options: Making Grids Ready for Renewables</h1>
            <p class="lead">An interactive exploration of a proposed market product to manage energy imbalance risk.</p>
            <p><small>Based on the paper: E. Spyrou, Q. Zhang, R. B. Hytowitz, B. F. Hobbs, S. Tyagi, M. Cai, and M. Blonsky, "Flexibility Options: A Proposed Product for Managing Imbalance Risk."</small></p>
        </header>

        <section class="explanation">
            <h2>The Challenge: Sunny Days, Windy Nights, and Grid Wobbles</h2>
            <p>
                Our electricity grid is undergoing a massive transformation. Wind turbines and solar panels, known as <a href="https://en.wikipedia.org/wiki/Variable_renewable_energy" target="_blank">Variable Renewable Energy</a> (VRE), are crucial for a cleaner future. However, their output isn't constant â€“ the sun doesn't always shine, and the wind doesn't always blow predictably.
            </p>
            <p>
                This variability creates a challenge for grid operators and market participants. Electricity supply and demand must be balanced *perfectly* in real-time. But decisions about how much power to generate are often made a day in advance. What happens when the wind forecast used for planning yesterday doesn't match the actual wind speed today? This mismatch is called an <span class="term">imbalance</span>.
            </p>
            <div class="info-box">
                <strong>Key Idea:</strong> Managing the difference between planned electricity generation (Day-Ahead) and actual generation (Real-Time) is becoming harder and more expensive with increasing VRE.
            </div>
        </section>

        <section class="explanation">
            <h2>Two Timeframes: Day-Ahead vs. Real-Time</h2>
            <p>
                Modern electricity markets typically operate in two main stages:
            </p>
            <ul>
                <li><strong>Day-Ahead (DA) Market:</strong> Participants (generators, large consumers) submit bids and offers for electricity for each hour of the *next* day. The grid operator runs a complex optimization to determine the least-cost way to meet forecasted demand, setting DA schedules and prices.</li>
                <li><strong>Real-Time (RT) Market:</strong> As the actual hour approaches, the grid operator makes fine-tuning adjustments based on updated forecasts and actual system conditions. Prices in the RT market can be much more volatile than DA prices, reflecting the immediate need to balance the grid.</li>
            </ul>
            <p>
                Think of it like planning a large dinner party (DA) versus making last-minute adjustments when guests arrive or dishes run low (RT).
            </p>
            <!-- Simple Timeline Visualization (Could be enhanced) -->
            <div class="text-center my-4">
                <svg width="80%" height="80" viewBox="0 0 600 60">
                    <line x1="10" y1="30" x2="590" y2="30" stroke="#ccc" stroke-width="2"/>
                    <circle cx="50" cy="30" r="5" fill="#0d6efd"/>
                    <text x="50" y="50" text-anchor="middle" font-size="12">DA Market Clears</text>
                    <text x="50" y="15" text-anchor="middle" font-size="12">(e.g., Noon Today)</text>

                    <circle cx="300" cy="30" r="5" fill="#ffc107"/>
                    <text x="300" y="50" text-anchor="middle" font-size="12">Delivery Hour Starts</text>
                     <text x="300" y="15" text-anchor="middle" font-size="12">(e.g., 2 PM Tomorrow)</text>

                    <circle cx="550" cy="30" r="5" fill="#198754"/>
                    <text x="550" y="50" text-anchor="middle" font-size="12">RT Adjustments</text>
                     <text x="550" y="15" text-anchor="middle" font-size="12">(During the Hour)</text>

                    <line x1="50" y1="30" x2="300" y2="30" stroke="#aaa" stroke-dasharray="5,5"/>
                    <line x1="300" y1="30" x2="550" y2="30" stroke="#aaa" stroke-dasharray="5,5"/>
                </svg>
            </div>
        </section>

        <section class="explanation">
            <h2>The Wind Farm's Dilemma: Forecast vs. Reality</h2>
            <p>
                Imagine you run a wind farm. In the DA market, based on a forecast, you commit to selling 50 Megawatt-hours (MWh) of energy for a specific hour tomorrow at the DA price, say $30/MWh.
            </p>
            <p>
                But tomorrow, the wind is weaker than expected, and you only produce 30 MWh. You have a <span class="term">shortfall</span> of 20 MWh. You still have the obligation to deliver 50 MWh. To fulfill this, you effectively have to buy back the missing 20 MWh from the RT market.
            </p>
            <p>
                What if the RT price ($A_t^{RT}$) during that hour spikes to $100/MWh due to high demand or lack of supply? You sold that energy for $30/MWh but have to buy it back at $100/MWh, losing $70 on each missing MWh! Conversely, if the wind is stronger and you produce 70 MWh (a <span class="term">surplus</span> of 20 MWh), you might sell the extra energy at the RT price. If the RT price is low, this extra revenue might be small.
            </p>
            <p>
                This difference between your DA commitment ($P_{i,t}^{DA}$) and your actual RT production ($P_{i,s,t}^{RT}$ in scenario $s$) creates financial risk.
            </p>

            <div class="interactive-visualization card">
                <div class="card-body">
                    <h5 class="card-title text-center">Wind Farm Imbalance Risk</h5>
                    <div id="imbalanceRiskViz"></div>
                    <div class="row mt-3">
                        <div class="col-md-4 param-control">
                            <label for="daCommitSlider" class="form-label slider-label">DA Commitment (MWh): <span id="daCommitValue" class="value-display">50</span></label>
                            <input type="range" class="form-range" id="daCommitSlider" min="0" max="100" value="50" step="1">
                        </div>
                        <div class="col-md-4 param-control">
                            <label for="rtActualSlider" class="form-label slider-label">RT Actual Production (MWh): <span id="rtActualValue" class="value-display">30</span></label>
                            <input type="range" class="form-range" id="rtActualSlider" min="0" max="100" value="30" step="1">
                        </div>
                         <div class="col-md-4 param-control">
                            <label for="rtPriceSlider" class="form-label slider-label">RT Market Price ($/MWh): <span id="rtPriceValue" class="value-display">100</span></label>
                            <input type="range" class="form-range" id="rtPriceSlider" min="0" max="200" value="100" step="1">
                        </div>
                    </div>
                     <div class="text-center mt-2" id="imbalanceResult">
                        <!-- Results updated by JS -->
                     </div>
                </div>
            </div>
        </section>

        <section class="explanation">
            <h2>Hedging the Risk: Introducing Flexibility Options (FOs)</h2>
            <p>
                How can our wind farm owner manage this risk? They need a way to hedge against unfavorable RT prices when they have an imbalance. This is where the paper's proposed product, <span class="term">Flexibility Options (FOs)</span>, comes in.
            </p>
            <p>
                An FO is like an insurance policy against specific imbalance scenarios. It's a financial contract traded in the DA market that gives the buyer the *right* (but not the obligation) to effectively settle their energy imbalance at a pre-agreed price, called the <span class="term">strike price</span> ($VC_{r,t}^{\uparrow \downarrow}$), under certain conditions.
            </p>
            <div class="info-box">
                <strong>Analogy:</strong> Think of flight cancellation insurance. You pay a small premium upfront. If your flight is cancelled (the trigger event), the insurance pays out, covering your costs (the hedge). If the flight is not cancelled, you only lose the premium.
            </div>
            <p>
                FOs are "dual-trigger" options, meaning two conditions must be met for them to be exercised and pay out in RT:
            </p>
            <ol>
                <li><strong>Quantity Trigger:</strong> The buyer must actually have an imbalance relative to a specific threshold associated with the FO tier ($P_{i,s,t}^{RT}$ vs $P_{i,s',t}$ from the paper, simplified here as $P_{i,t}^{DA}$).
                    <ul>
                        <li>For an <span class="term">Upward FO</span> (hedging shortfalls): Actual RT production must be *less* than the trigger quantity.</li>
                        <li>For a <span class="term">Downward FO</span> (hedging surpluses): Actual RT production must be *more* than the trigger quantity.</li>
                    </ul>
                </li>
                <li><strong>Price Trigger:</strong> The RT market price ($A_t^{RT}$) must be unfavorable relative to the FO's strike price ($VC_{r,t}^{\uparrow \downarrow}$).
                    <ul>
                        <li>For an Upward FO: RT price must be *higher* than the strike price.</li>
                        <li>For a Downward FO: RT price must be *lower* than the strike price.</li>
                    </ul>
                </li>
            </ol>
             <p>
                Let's break down the payoff with an interactive example. Imagine our wind farm bought an Upward FO in the DA market with a strike price of $50/MWh to hedge against shortfalls relative to its 50 MWh DA commitment.
            </p>
        </section>

        <section class="explanation">
            <h3>Interactive FO Dual-Trigger Visualization</h3>
            <p>Adjust the sliders below to see when an Upward FO (hedging a shortfall) or Downward FO (hedging a surplus) would exercise and what the financial outcome is for the wind farm's imbalance.</p>

            <div class="interactive-visualization card">
                 <div class="card-body">
                    <h5 class="card-title text-center">Flexibility Option Exercise Logic</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div id="foDualTriggerViz"></div>
                        </div>
                        <div class="col-md-6">
                             <div class="param-control">
                                <label class="form-label slider-label">Select FO Type:</label>
                                <div class="form-check form-check-inline">
                                  <input class="form-check-input" type="radio" name="foTypeRadio" id="upwardFO" value="upward" checked>
                                  <label class="form-check-label" for="upwardFO">Upward (Hedge Shortfall)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                  <input class="form-check-input" type="radio" name="foTypeRadio" id="downwardFO" value="downward">
                                  <label class="form-check-label" for="downwardFO">Downward (Hedge Surplus)</label>
                                </div>
                            </div>
                            <div class="param-control">
                                <label for="foDaCommitSlider" class="form-label slider-label">DA Commitment (MWh): <span id="foDaCommitValue" class="value-display">50</span></label>
                                <input type="range" class="form-range" id="foDaCommitSlider" min="0" max="100" value="50" step="1">
                            </div>
                            <div class="param-control">
                                <label for="foRtActualSlider" class="form-label slider-label">RT Actual Production (MWh): <span id="foRtActualValue" class="value-display">30</span></label>
                                <input type="range" class="form-range" id="foRtActualSlider" min="0" max="100" value="30" step="1">
                            </div>
                             <div class="param-control">
                                <label for="foRtPriceSlider" class="form-label slider-label">RT Market Price ($/MWh): <span id="foRtPriceValue" class="value-display">100</span></label>
                                <input type="range" class="form-range" id="foRtPriceSlider" min="0" max="200" value="100" step="1">
                            </div>
                            <div class="param-control">
                                <label for="foStrikePriceSlider" class="form-label slider-label">FO Strike Price ($/MWh): <span id="foStrikePriceValue" class="value-display">50</span></label>
                                <input type="range" class="form-range" id="foStrikePriceSlider" min="0" max="200" value="50" step="1">
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3" id="foResult">
                         <!-- Results updated by JS -->
                    </div>
                 </div>
            </div>

            <div class="equation">
                <p>Mathematically, the conditions for exercising FOs (simplified from Eqs 1 & 2 in the paper) are:</p>
                <ul>
                    <li><strong>Upward FO Exercise:</strong> If $P_{i,t}^{DA} > P_{i,s,t}^{RT}$ (Quantity Trigger Met) AND $A_t^{RT} > VC_{r,t}^{\uparrow}$ (Price Trigger Met)</li>
                    <li><strong>Downward FO Exercise:</strong> If $P_{i,t}^{DA} < P_{i,s,t}^{RT}$ (Quantity Trigger Met) AND $A_t^{RT} < VC_{r,t}^{\downarrow}$ (Price Trigger Met)</li>
                </ul>
                <p>The RT payoff per MWh of exercised FO is:</p>
                 <ul>
                    <li><strong>Upward FO Payoff:</strong> $max(0, A_t^{RT} - VC_{r,t}^{\uparrow})$</li>
                    <li><strong>Downward FO Payoff:</strong> $max(0, VC_{r,t}^{\downarrow} - A_t^{RT})$</li>
                </ul>
                <p>This payoff helps offset the cost of buying back a shortfall at a high RT price or the low revenue from selling a surplus at a low RT price.</p>
            </div>

        </section>

        <section class="explanation">
            <h2>Who Buys, Who Sells? And What are Tiers?</h2>
            <p>
                <strong>FO Buyers ($G^B$):</strong> Typically, participants with uncertain net positions between DA and RT, like VRE generators (wind, solar) or large consumers with variable demand. They pay a <span class="term">premium</span> in the DA market to acquire the FO.
            </p>
            <p>
                <strong>FO Sellers ($G^S$):</strong> Participants with <span class="term">flexibility</span> â€“ the ability to quickly adjust their generation or consumption in RT. Examples include gas turbines, batteries, or industrial consumers who can curtail load. They receive the premium in DA and are obligated to provide the energy adjustment (or financial equivalent) if the FO is exercised in RT. They commit to their strike price ($VC_{r,t}^{\uparrow \downarrow}$) in the DA market.
            </p>
            <p>
                <strong>Tiers ($r$):</strong> The paper proposes multiple "tiers" of FOs. Think of these as options covering different levels of imbalance risk. A Tier 1 FO might hedge against smaller, more frequent imbalances, while a higher Tier FO might hedge against larger, less frequent (extreme) imbalances. Buyers submit their expected RT output distribution ($P_{i,s,t}$ for different scenarios $s$), and the system operator uses this to define the trigger quantities for different tiers, linked to probabilities ($\Pi_r^{\uparrow \downarrow}$). This allows for more granular risk management.
            </p>
             <div class="info-box">
                <strong>Key Idea:</strong> FOs create a market for flexibility itself. Sellers reveal their cost of providing flexibility (via strike prices), and buyers reveal their need for hedging (via the quantities and tiers they purchase).
            </div>
        </section>

         <section class="explanation">
            <h2>Co-optimization: Trading Energy and FOs Together</h2>
            <p>
                A crucial aspect of the proposal is <span class="term">co-optimization</span>. This means FOs are bought and sold within the same DA market optimization process as energy itself (see Objective Function Eq 4 and constraints Eq 5-13 in the paper).
            </p>
            <p>
                Why is this important?
            </p>
            <ul>
                <li><strong>Accurate Pricing:</strong> The value (premium) of an FO ($A_{r,t}^{\uparrow \downarrow}$) depends on the potential need for it (driven by buyers' expected imbalances) and the cost of providing the underlying flexibility (driven by sellers' strike prices and their opportunity cost of *not* selling energy). Co-optimization considers these factors together.</li>
                <li><strong>Efficient Resource Use:</strong> The DA market decides simultaneously how much energy each generator should produce and how much flexibility (via FOs) they should reserve. This prevents situations where a generator sells energy DA that it might need for flexibility RT, or vice-versa.</li>
                <li><strong>Dynamic Value:</strong> The price of FOs isn't fixed; it changes based on system conditions (expected VRE output, load forecasts, generator availability) reflected in the DA market.</li>
            </ul>
             <p>
                The DA market objective aims to minimize the total expected system cost, including DA energy production costs (Eq 4a) and the probability-weighted expected costs/savings from exercising FOs in RT (Eqs 4b, 4c, 4d).
            </p>
        </section>

        <section class="explanation">
            <h2>Benefits: Why FOs Could Be Better</h2>
            <p>
                Compared to traditional ways of managing reserves (often based on simple rules or less sophisticated products like the Imbalance Reserve (IR) discussed in the paper's comparison), FOs offer potential advantages:
            </p>
            <ul>
                <li><strong>Targeted Hedging:</strong> Participants hedge their *own* specific imbalance risks, rather than relying on system-wide reserve procurement that might not match their needs.</li>
                <li><strong>Value-Driven Flexibility Pricing:</strong> FOs create explicit prices for flexibility based on both the sellers' costs (strike prices) and the buyers' needs (demand derived from imbalance forecasts).</li>
                <li><strong>Cost Causation:</strong> Participants who cause the need for flexibility (buyers with uncertainty) pay for it through FO premiums.</li>
                <li><strong>Revenue Neutrality:</strong> The settlement mechanism (Eqs 14-22) is designed so that payments collected by the system operator for FOs generally equal payments made, avoiding socialization of costs.</li>
                <li><strong>Improved DA Schedules:</strong> By pricing imbalance risk, FOs encourage more realistic DA commitments from VREs and better anticipation of RT needs.</li>
            </ul>
             <div class="info-box">
                While traditional reserves often have administratively determined demand curves, the demand for FOs arises endogenously from the participants' own forecasts and risk profiles.
            </div>
        </section>

        <section class="explanation">
            <h2>Conclusion: A Step Towards a More Flexible Grid</h2>
            <p>
                Flexibility Options represent a sophisticated market design proposal aimed at integrating variable renewables more efficiently and reliably. By creating an explicit market for flexibility and allowing participants to hedge their specific DA-RT imbalance risks, FOs can:
            </p>
            <ul>
                <li>Provide better price signals for the value of flexibility.</li>
                <li>Reduce overall system costs for managing uncertainty.</li>
                <li>Allocate costs more fairly based on risk contribution.</li>
                <li>Offer VRE generators and other uncertain resources a tool to manage financial risk.</li>
            </ul>
            <p>
                While implementation involves complexities (like defining tiers, handling transmission constraints, and ensuring participant understanding), the core concept of a co-optimized, dual-trigger option holds promise for navigating the challenges of a high-renewable electricity future.
            </p>
        </section>

        <footer class="text-center text-muted mt-5 mb-3">
            <small>Interactive explanation created based on the referenced paper. Visualizations are illustrative.</small>
        </footer>

    </div> <!-- /container -->

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Inline Javascript for Visualizations -->
    <script>
        // --- Imbalance Risk Visualization ---
        const daCommitSlider = document.getElementById('daCommitSlider');
        const rtActualSlider = document.getElementById('rtActualSlider');
        const rtPriceSlider = document.getElementById('rtPriceSlider');
        const daCommitValue = document.getElementById('daCommitValue');
        const rtActualValue = document.getElementById('rtActualValue');
        const rtPriceValue = document.getElementById('rtPriceValue');
        const imbalanceResult = document.getElementById('imbalanceResult');

        function updateImbalanceRisk() {
            const daCommit = parseFloat(daCommitSlider.value);
            const rtActual = parseFloat(rtActualSlider.value);
            const rtPrice = parseFloat(rtPriceSlider.value);
            const daPrice = 30; // Assumed DA price for calculation

            daCommitValue.textContent = daCommit.toFixed(0);
            rtActualValue.textContent = rtActual.toFixed(0);
            rtPriceValue.textContent = rtPrice.toFixed(0);

            const imbalance = daCommit - rtActual; // Positive = shortfall, Negative = surplus
            const imbalanceCost = imbalance * rtPrice; // Cost to buy back shortfall / Revenue from selling surplus
            const daRevenue = daCommit * daPrice;
            // Simplified Net: DA Revenue - Cost to cover shortfall OR + Revenue from surplus
            // More accurately: Revenue from actual production at RT price + DA hedge payment
            // Simplified approach for illustration: DA Revenue - RT imbalance settlement cost
            const simplifiedNetEffect = -imbalanceCost; // Effect of imbalance settlement only

            let resultText = `DA Commitment: ${daCommit} MWh @ $${daPrice}/MWh<br>`;
            resultText += `RT Actual: ${rtActual} MWh<br>`;
            resultText += `Imbalance: ${imbalance.toFixed(1)} MWh `;
            if (imbalance > 0) {
                resultText += `(Shortfall)<br>`;
                resultText += `Cost to cover shortfall in RT: ${imbalance.toFixed(1)} MWh * $${rtPrice}/MWh = <span class="text-danger">$${imbalanceCost.toFixed(2)}</span>`;
            } else if (imbalance < 0) {
                 resultText += `(Surplus)<br>`;
                 resultText += `Revenue from selling surplus in RT: ${(-imbalance).toFixed(1)} MWh * $${rtPrice}/MWh = <span class="text-success">$${(-imbalanceCost).toFixed(2)}</span>`;
            } else {
                resultText += `(Balanced)<br>`;
                resultText += `No RT settlement cost/revenue for imbalance.`;
            }
            imbalanceResult.innerHTML = resultText;

            // Basic p5 sketch for imbalance viz (optional enhancement)
            // Could show bars for DA commit vs RT actual
        }

        daCommitSlider.addEventListener('input', updateImbalanceRisk);
        rtActualSlider.addEventListener('input', updateImbalanceRisk);
        rtPriceSlider.addEventListener('input', updateImbalanceRisk);
        updateImbalanceRisk(); // Initial calculation

        // --- Flexibility Option Dual Trigger Visualization ---
        const foDaCommitSlider = document.getElementById('foDaCommitSlider');
        const foRtActualSlider = document.getElementById('foRtActualSlider');
        const foRtPriceSlider = document.getElementById('foRtPriceSlider');
        const foStrikePriceSlider = document.getElementById('foStrikePriceSlider');
        const foDaCommitValue = document.getElementById('foDaCommitValue');
        const foRtActualValue = document.getElementById('foRtActualValue');
        const foRtPriceValue = document.getElementById('foRtPriceValue');
        const foStrikePriceValue = document.getElementById('foStrikePriceValue');
        const foResult = document.getElementById('foResult');
        const upwardFORadio = document.getElementById('upwardFO');
        const downwardFORadio = document.getElementById('downwardFO');

        let foSketch; // To hold the p5 sketch instance

        function setupFOSketch(p) {
            let canvas;
             // Adjust canvas size based on container width, maintain aspect ratio
            const container = document.getElementById('foDualTriggerViz');
            const containerWidth = container.offsetWidth;
            const canvasWidth = Math.max(300, containerWidth * 0.95); // Ensure minimum width
            const canvasHeight = canvasWidth * 0.6; // Maintain aspect ratio


            p.setup = function() {
                canvas = p.createCanvas(canvasWidth, canvasHeight);
                canvas.parent('foDualTriggerViz'); // Attach canvas to the div
                p.noLoop(); // Redraw only when inputs change
                 // Add event listeners within setup to ensure p is defined
                foDaCommitSlider.addEventListener('input', () => { p.redraw(); updateFOResult(); });
                foRtActualSlider.addEventListener('input', () => { p.redraw(); updateFOResult(); });
                foRtPriceSlider.addEventListener('input', () => { p.redraw(); updateFOResult(); });
                foStrikePriceSlider.addEventListener('input', () => { p.redraw(); updateFOResult(); });
                upwardFORadio.addEventListener('change', () => { p.redraw(); updateFOResult(); });
                downwardFORadio.addEventListener('change', () => { p.redraw(); updateFOResult(); });
                updateFOResult(); // Initial calculation
            };

            p.draw = function() {
                p.background(248); // Light background

                const daCommit = parseFloat(foDaCommitSlider.value);
                const rtActual = parseFloat(foRtActualSlider.value);
                const rtPrice = parseFloat(foRtPriceSlider.value);
                const strikePrice = parseFloat(foStrikePriceSlider.value);
                const isUpwardFO = upwardFORadio.checked;

                const maxEnergy = 100; // Max value for energy axis
                const maxPrice = 200; // Max value for price axis
                const padding = 40;
                const plotWidth = p.width - 2 * padding;
                const plotHeight = p.height - 2 * padding;

                // --- Draw Axes ---
                p.stroke(150);
                p.strokeWeight(1);
                // Y-axis (Price)
                p.line(padding, padding, padding, p.height - padding);
                // X-axis (Energy)
                p.line(padding, p.height - padding, p.width - padding, p.height - padding);

                // Axis Labels
                p.fill(50);
                p.noStroke();
                p.textAlign(p.CENTER, p.CENTER);
                p.text("Price ($/MWh)", padding / 2, p.height / 2);
                p.text("Energy (MWh)", p.width / 2, p.height - padding / 2);

                // Axis Ticks
                p.textAlign(p.CENTER, p.TOP);
                 for (let e = 0; e <= maxEnergy; e += 20) {
                    const x = p.map(e, 0, maxEnergy, padding, p.width - padding);
                    p.stroke(200);
                    p.line(x, p.height - padding - 5, x, p.height - padding + 5);
                    p.noStroke();
                    p.fill(100);
                    p.text(e, x, p.height - padding + 8);
                 }
                 p.textAlign(p.RIGHT, p.CENTER);
                 for (let pr = 0; pr <= maxPrice; pr += 50) {
                     const y = p.map(pr, 0, maxPrice, p.height - padding, padding);
                     p.stroke(200);
                     p.line(padding - 5, y, padding + 5, y);
                     p.noStroke();
                     p.fill(100);
                     p.text(pr, padding - 8, y);
                 }

                // --- Map values to coordinates ---
                const daCommitX = p.map(daCommit, 0, maxEnergy, padding, p.width - padding);
                const rtActualX = p.map(rtActual, 0, maxEnergy, padding, p.width - padding);
                const rtPriceY = p.map(rtPrice, 0, maxPrice, p.height - padding, padding);
                const strikePriceY = p.map(strikePrice, 0, maxPrice, p.height - padding, padding);

                // --- Draw Trigger Lines and Actual Values ---
                // DA Commitment (Quantity Trigger Reference)
                p.stroke(255, 193, 7); // Bootstrap warning color
                p.strokeWeight(1.5);
                p.strokeDasharray = [5, 5]; // Use p5 function if available or simulate
                p.line(daCommitX, padding, daCommitX, p.height - padding);
                p.noStroke();
                p.fill(255, 193, 7);
                p.text("DA Commit", daCommitX, padding - 10);

                // Strike Price (Price Trigger Reference)
                p.stroke(108, 117, 125); // Bootstrap secondary color
                p.strokeWeight(1.5);
                p.line(padding, strikePriceY, p.width - padding, strikePriceY);
                 p.noStroke();
                p.fill(108, 117, 125);
                p.textAlign(p.LEFT, p.BOTTOM);
                p.text("Strike Price", padding + 5, strikePriceY - 5);

                // RT Actual Production
                p.stroke(220, 53, 69); // Bootstrap danger color
                p.strokeWeight(2);
                p.line(rtActualX, padding, rtActualX, p.height - padding);
                p.noStroke();
                p.fill(220, 53, 69);
                p.textAlign(p.CENTER, p.BOTTOM);
                p.text("RT Actual", rtActualX, padding - 10);

                // RT Market Price
                p.stroke(13, 110, 253); // Bootstrap primary color
                 p.strokeWeight(2);
                p.line(padding, rtPriceY, p.width - padding, rtPriceY);
                p.noStroke();
                p.fill(13, 110, 253);
                p.textAlign(p.LEFT, p.TOP);
                p.text("RT Price", padding + 5, rtPriceY + 5);

                // --- Indicate Trigger Zones (Optional Enhancement) ---
                 const { quantityTriggerMet, priceTriggerMet } = checkFOTriggers();
                 p.noStroke();
                 p.textAlign(p.LEFT, p.TOP);
                 if (isUpwardFO) {
                     // Quantity trigger zone: left of DA Commit
                     p.fill(255, 193, 7, 30); // Transparent warning
                     p.rect(padding, padding, daCommitX - padding, plotHeight);
                      // Price trigger zone: above Strike Price
                     p.fill(108, 117, 125, 30); // Transparent secondary
                     p.rect(padding, padding, plotWidth, strikePriceY - padding);

                     if (quantityTriggerMet && priceTriggerMet) {
                         p.fill(25, 135, 84, 50); // Transparent success
                         p.rect(padding, padding, daCommitX - padding, strikePriceY - padding);
                     }
                 } else { // Downward FO
                     // Quantity trigger zone: right of DA Commit
                     p.fill(255, 193, 7, 30);
                     p.rect(daCommitX, padding, (p.width - padding) - daCommitX, plotHeight);
                      // Price trigger zone: below Strike Price
                     p.fill(108, 117, 125, 30);
                     p.rect(padding, strikePriceY, plotWidth, (p.height - padding) - strikePriceY);

                      if (quantityTriggerMet && priceTriggerMet) {
                         p.fill(25, 135, 84, 50); // Transparent success
                         p.rect(daCommitX, strikePriceY, (p.width - padding) - daCommitX, (p.height - padding) - strikePriceY);
                     }
                 }
            };
        }

        function checkFOTriggers() {
             const daCommit = parseFloat(foDaCommitSlider.value);
             const rtActual = parseFloat(foRtActualSlider.value);
             const rtPrice = parseFloat(foRtPriceSlider.value);
             const strikePrice = parseFloat(foStrikePriceSlider.value);
             const isUpwardFO = upwardFORadio.checked;

             let quantityTriggerMet = false;
             let priceTriggerMet = false;

             if (isUpwardFO) { // Upward FO - hedging shortfall
                 quantityTriggerMet = rtActual < daCommit;
                 priceTriggerMet = rtPrice > strikePrice;
             } else { // Downward FO - hedging surplus
                 quantityTriggerMet = rtActual > daCommit;
                 priceTriggerMet = rtPrice < strikePrice;
             }
             return { quantityTriggerMet, priceTriggerMet };
        }


        function updateFOResult() {
            const daCommit = parseFloat(foDaCommitSlider.value);
            const rtActual = parseFloat(foRtActualSlider.value);
            const rtPrice = parseFloat(foRtPriceSlider.value);
            const strikePrice = parseFloat(foStrikePriceSlider.value);
            const isUpwardFO = upwardFORadio.checked;
            const daPrice = 30; // Assumed DA Price

            foDaCommitValue.textContent = daCommit.toFixed(0);
            foRtActualValue.textContent = rtActual.toFixed(0);
            foRtPriceValue.textContent = rtPrice.toFixed(0);
            foStrikePriceValue.textContent = strikePrice.toFixed(0);

            const imbalance = daCommit - rtActual; // Positive = shortfall, Negative = surplus
            const absImbalance = Math.abs(imbalance);
            const rtImbalanceCost = imbalance * rtPrice; // Cost (+) if shortfall, Revenue (-) if surplus

            const { quantityTriggerMet, priceTriggerMet } = checkFOTriggers();
            const foExercised = quantityTriggerMet && priceTriggerMet;

            let foPayoffPerMWh = 0;
            let totalFOPayoff = 0;
            let netImbalanceCostWithFO = rtImbalanceCost;

            if (foExercised) {
                if (isUpwardFO) { // Upward FO payoff
                    foPayoffPerMWh = Math.max(0, rtPrice - strikePrice);
                    totalFOPayoff = absImbalance * foPayoffPerMWh; // Payoff received by buyer
                    netImbalanceCostWithFO = rtImbalanceCost - totalFOPayoff; // Reduces the cost
                } else { // Downward FO payoff
                    foPayoffPerMWh = Math.max(0, strikePrice - rtPrice);
                    totalFOPayoff = absImbalance * foPayoffPerMWh; // Payoff received by buyer
                     // Reduces the loss from low RT price OR adds to surplus revenue
                    // Net cost = RT cost (negative if surplus revenue) - FO Payoff
                    netImbalanceCostWithFO = rtImbalanceCost - totalFOPayoff;
                }
            }

            let resultText = `<b>Scenario:</b> ${isUpwardFO ? 'Hedging Shortfall (Upward FO)' : 'Hedging Surplus (Downward FO)'}<br>`;
            resultText += `Imbalance: ${imbalance.toFixed(1)} MWh `;
            resultText += `(${imbalance > 0 ? 'Shortfall' : (imbalance < 0 ? 'Surplus' : 'Balanced')})<br>`;
            resultText += `RT Settlement Cost (without FO): <span class="${rtImbalanceCost >= 0 ? 'text-danger' : 'text-success'}">$${rtImbalanceCost.toFixed(2)}</span><br><hr>`;

            resultText += `Quantity Trigger Met? ${quantityTriggerMet ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'} `;
            if (isUpwardFO) resultText += `(Is ${rtActual.toFixed(0)} < ${daCommit.toFixed(0)}?)<br>`;
            else resultText += `(Is ${rtActual.toFixed(0)} > ${daCommit.toFixed(0)}?)<br>`;

            resultText += `Price Trigger Met? ${priceTriggerMet ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'} `;
             if (isUpwardFO) resultText += `(Is ${rtPrice.toFixed(0)} > ${strikePrice.toFixed(0)}?)<br>`;
            else resultText += `(Is ${rtPrice.toFixed(0)} < ${strikePrice.toFixed(0)}?)<br>`;

            resultText += `<b>FO Exercised? ${foExercised ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'}</b><br>`;

            if (foExercised) {
                resultText += `FO Payoff per MWh: $${foPayoffPerMWh.toFixed(2)}<br>`;
                resultText += `Total FO Payoff (for ${absImbalance.toFixed(1)} MWh): <span class="text-success">$${totalFOPayoff.toFixed(2)}</span><br>`;
                resultText += `Net Imbalance Cost (with FO): <span class="${netImbalanceCostWithFO >= 0 ? 'text-danger' : 'text-success'}">$${netImbalanceCostWithFO.toFixed(2)}</span>`;
            } else {
                 resultText += `Net Imbalance Cost (with FO): <span class="${netImbalanceCostWithFO >= 0 ? 'text-danger' : 'text-success'}">$${netImbalanceCostWithFO.toFixed(2)}</span> (Same as without FO)`;
            }
             resultText += `<br><small>(Note: DA premium paid for the FO is not included in this calculation)</small>`;

            foResult.innerHTML = resultText;
        }

        // Initialize the p5 sketch for FO visualization
        document.addEventListener('DOMContentLoaded', () => {
            foSketch = new p5(setupFOSketch);
        });


    </script>

</body>
</html>